# below derived from:
# https://github.com/AUTOMATIC1111/stable-diffusion-webui#automatic-installation-on-linux


module purge

export OSC_CLASS_ID="<%= context.classroom %>"
export OSC_PROJECT_ID="<%= context.account %>"

module load project/ondemand python/3.9-2022.05 git/2.39.0
module load app_stable_diffusion/1.5.1

export OSC_CLASS_ID='stable-diff-dev'
CLASS_DIR="$HOME/osc_classes/${OSC_CLASS_ID:-osc_class}"

mkdir -p $CLASS_DIR/extensions
OUT_DIR="$CLASS_DIR/outputs"
mkdir -p $OUT_DIR

CONFIG="$PWD/config.json"

cat <<< $(jq --arg out "$OUT_DIR" '.outdir_samples = $out' $CONFIG) > $CONFIG
cat <<< $(jq --arg out "$OUT_DIR" '.outdir_txt2img_samples = $out' $CONFIG) > $CONFIG
cat <<< $(jq --arg out "$OUT_DIR" '.outdir_img2img_samples = $out' $CONFIG) > $CONFIG
cat <<< $(jq --arg out "$OUT_DIR" '.outdir_extras_samples = $out' $CONFIG) > $CONFIG
cat <<< $(jq --arg out "$OUT_DIR" '.outdir_grids = $out' $CONFIG) > $CONFIG
cat <<< $(jq --arg out "$OUT_DIR" '.outdir_txt2img_grids = $out' $CONFIG) > $CONFIG
cat <<< $(jq --arg out "$OUT_DIR" '.outdir_img2img_grids = $out' $CONFIG) > $CONFIG
cat <<< $(jq --arg out "$OUT_DIR" '.outdir_save = $out' $CONFIG) > $CONFIG
cat <<< $(jq --arg out "$OUT_DIR" '.outdir_init_images = $out' $CONFIG) > $CONFIG


FILES=$(ls /dev/nvidia*)

for f in $FILES; do
  DEVICE=$(basename "$f" | sed -rn 's#^nvidia([0-9]+)$#\1#p')
  if [[ -n "$DEVICE" ]]; then
    export REAL_DEVICE=$DEVICE
  fi
done

# Copy over classroom materials if the env variable exists
if [[ -n "$OSC_CLASS_FILES" ]]; then
  set -x  
  mkdir -p "$CLASS_DIR"
  touch "$CLASS_DIR/0_${OSC_CLASS_ID:-osc_class}.md"
  rsync -avz --ignore-existing "$OSC_CLASS_FILES" "$CLASS_DIR"
  { set +x; } 2>/dev/null
fi

# debug
module list
set -x
export CUDA_9c74391b="$REAL_DEVICE=6G"

# Launch Sever
echo "Starting Stable Diffusion..."

cd $OSC_STABLE_DIFFUSION_PATH

python $OSC_STABLE_DIFFUSION_PATH/launch.py \
  --data-dir "$CLASS_DIR" \
  --ui-settings-file "$CONFIG" \
  --skip-install \
  --port $port \
  --listen \
  --skip-prepare-environment \
  --subpath "/rnode/$HOST_CFG/$PORT_CFG" \
  --server-name $(hostname) \
  --no-half
