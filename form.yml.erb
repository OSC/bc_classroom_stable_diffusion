<%-
  # Grab the projects P#####
  groups = OodSupport::User.new.groups.sort_by(&:id).tap { |groups|
    groups.unshift(groups.delete(OodSupport::Process.group))
  }.map(&:name).grep(/^P./)

  classrooms = OodAppkit.clusters.map do |cluster|
    [ cluster.id.to_s, cluster.custom_config[:classrooms].to_h ]
  end.to_h.map do |cluster_id, classrooms|
    classes = classrooms.select do |k,v|
      k.start_with?('stable_diffusion') && groups.include?(v)
    end.map do |k,v|

      tokens = k.gsub('stable_diffusion/', '').split('/')

      # cluster, size, module_type & clusterfs are not used

      {
        name: tokens[0].nil? ? 'unknown' : tokens[0],
        size: tokens[1].nil? ? 1 : tokens[1].to_i,
        time: tokens[2].nil? ? 1 : tokens[2].to_i,
        cluster_fs: tokens[3].nil? ? 'pitzer' : tokens[3].to_s,
        module_type: tokens[4].nil? ? 'default' : tokens[4].to_s,
        cluster: cluster_id.to_s,
        account: v,
      }
    end.reject do |arr|
      arr.empty?
    end
  end.flatten
-%>
---
cluster:
  - "kubernetes"
  - "kubernetes-test"
  - "kubernetes-dev"

form:
  - classroom
  - account
  - time
  - cluster_fs
  - module_type


attributes:
  account:
    widget: "hidden_field"
  cluster_fs:
    widget: "hidden_field"
  module_type:
    widget: "hidden_field"
  time:
    widget: "select"
    options:
      - [
          "1.5 hours", "1.5",
        ]
      - [
          "3 hours", "3",
          <%- classrooms.each do |cr| %>
            <%- unless cr[:time].to_i >= 3 %>
            data-option-for-classroom-<%= cr[:name].to_s.gsub('_', '-') %>: false,
            <%- end %>
          <%- end %>
        ]
      - [
          "6 hours", "6",
          <%- classrooms.each do |cr| %>
            <%- unless cr[:time].to_i >= 6 %>
            data-option-for-classroom-<%= cr[:name].to_s.gsub('_', '-') %>: false,
            <%- end %>
          <%- end %>
        ]
    help: Instructors can request longer times.

  classroom:
  <%- if classrooms.size >= 1 -%>
    widget: select
    options:
      <%- classrooms.each do |cr| %>
      - [
        "<%= cr[:name].gsub('_', ' ') %>", "<%= cr[:name] %>",
        data-set-account: "<%= cr[:account] %>",
        data-set-cluster-fs: "<%= cr[:cluster_fs] %>",
        data-set-module-type: "<%= cr[:module_type] %>",
        data-set-cluster: "<%= cr[:cluster] %>"
        ]
      <%- end %>
  <%- else -%>
    widget: 'hidden_field'
    value: 'no_classroom'
  <%- end -%>

